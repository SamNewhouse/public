# Define the user and worker processes
user www-data;                # Run worker processes as 'www-data' user
worker_processes auto;        # Automatically set worker process number based on CPU cores
pid /run/nginx.pid;           # File to store the nginx PID
include /etc/nginx/modules-enabled/*.conf;  # Load dynamic modules

events {
    worker_connections 1024;  # Maximum simultaneous connections per worker process
}

# ==== RTMP Configuration ====
rtmp {
    server {
        listen 1935;          # Listen on the default RTMP port (1935)
        chunk_size 4096;      # Size of RTMP chunks (helps streaming performance)
        allow publish all;    # Allow all clients to publish streams (no restriction)

        # Unified RTMP Application
        application live {
            live on;          # Enable live streaming mode
            record off;       # Disable recording of streams on server
            
            # HLS output for all stream keys (flat)
            hls on;
            hls_path /var/www/hls;
            hls_fragment 2;           # Make each segment 1 second
            hls_playlist_length 6;    # Playlist shows only the last x seconds/segments
            hls_cleanup on;           # Enable cleanup of old HLS fragments
            hls_nested on;            # Enable nested HLS directories

            # Multi-quality adaptive bitrate transcoding with ffmpeg
            # This spawns ffmpeg process for each incoming stream,
            # creating four output streams with different resolutions and bitrates.
            exec ffmpeg -i rtmp://localhost/live/$name \
            -c:v libx264 -b:v 5000k -s 1920x1080 -r 30 -g 30 -keyint_min 30 -preset veryfast -profile:v high -pix_fmt yuv420p -c:a aac -b:a 128k -ar 48000 -f flv rtmp://localhost/live/${name}_1080 \
            -c:v libx264 -b:v 1400k -s 854x480   -r 30 -g 30 -keyint_min 30 -preset veryfast -profile:v main -pix_fmt yuv420p -c:a aac -b:a 96k -ar 48000 -f flv rtmp://localhost/live/${name}_480;

            # Optional: Configure webhooks to notify backend on stream start/stop
            # These can be injected by your cloud-init or templating system
            # %{ if webhook_url != "" ~}
            # on_publish %%WEBHOOK_URL%%/start;
            # on_publish_done %%WEBHOOK_URL%%/end;
            # %{ endif ~}
        }
    }
}

# ==== HTTP Configuration ====
http {
    sendfile on;                 # Enable efficient file transfers
    tcp_nopush on;               # Slightly improve TCP performance
    tcp_nodelay on;
    keepalive_timeout 65;        # Timeout for keep-alive client connections
    types_hash_max_size 2048;    # Internal optimization for MIME types

    include /etc/nginx/mime.types;   # Load MIME types (content-types mapping)
    default_type application/octet-stream;  # Default MIME type

    # Logging configuration
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Enable gzip compression for common text-based file types
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # HTTP server block to serve HLS content and stats
    server {
        listen 8080;              # HTTP port for HLS playback and stats
        server_name _;            # Catch-all server

        # CORS headers for cross-origin requests from players on other domains
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Range' always;

        # Serve HLS files under /live URL path
        location /live {
            alias /var/www/hls;    # Maps URI /live to physical directory /var/www/hls
            types {
                application/vnd.apple.mpegurl m3u8;  # HLS playlist MIME
                video/mp2t ts;                        # HLS segment MIME
            }
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin * always;
        }

        # RTMP stats interface - view streaming server status
        location /stats {
            rtmp_stat all;                 # Provide full RTMP status info in XML
            rtmp_stat_stylesheet stat.xsl; # Basic styling for human-readable stats
        }

        # Health check endpoint for monitoring
        location /health {
            access_log off;               # Disable logging of health checks
            return 200 "healthy\n";      # Return HTTP 200 with simple text response
            add_header Content-Type text/plain;
        }
    }
}
