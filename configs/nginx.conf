# Define the user and worker processes
user www-data;                # Run worker processes as 'www-data' user
worker_processes auto;        # Automatically set worker process number based on CPU cores
pid /run/nginx.pid;           # File to store the nginx PID
include /etc/nginx/modules-enabled/*.conf;  # Load dynamic modules

events {
    worker_connections 1024;  # Maximum simultaneous connections per worker process
}


# ==== RTMP Configuration ====
rtmp {
    server {
        listen 1935;          # Listen on the default RTMP port (1935)
        chunk_size 4096;      # Size of RTMP chunks (helps streaming performance)
        allow publish all;    # Allow all clients to publish streams (no restriction)

        # RTMP Application for receiving live streams
        application live {
            live on;          # Enable live streaming mode
            record off;       # Disable recording of streams on server
            
            # Enable HLS (HTTP Live Streaming) output
            hls on;
            hls_path /var/www/hls/live;          # Directory to save HLS playlist and segment files
            hls_fragment 3;                     # Duration of each HLS segment in seconds
            hls_playlist_length 60;             # Length of the HLS playlist in seconds
            hls_cleanup on;                     # Enable cleanup of old HLS fragments

            # Multi-quality adaptive bitrate transcoding with ffmpeg
            # This spawns ffmpeg process for each incoming stream,
            # creating four output streams with different resolutions and bitrates.
            exec ffmpeg -i rtmp://localhost/live/$name \
              -c:v libx264 -b:v 5000k -s 1920x1080 -preset veryfast -g 60 -c:a aac -b:a 128k -f flv rtmp://localhost/hls/$name_1080 \
              -c:v libx264 -b:v 2800k -s 1280x720  -preset veryfast -g 60 -c:a aac -b:a 128k -f flv rtmp://localhost/hls/$name_720  \
              -c:v libx264 -b:v 1400k -s 854x480   -preset veryfast -g 60 -c:a aac -b:a 96k  -f flv rtmp://localhost/hls/$name_480  \
              -c:v libx264 -b:v 800k -s 640x360    -preset veryfast -g 60 -c:a aac -b:a 96k  -f flv rtmp://localhost/hls/$name_360;

            # Optional: Configure webhooks to notify backend on stream start/stop
            # These can be injected by your cloud-init or templating system
            # %{ if webhook_url != "" ~}
            # on_publish %%WEBHOOK_URL%%/start;
            # on_publish_done %%WEBHOOK_URL%%/end;
            # %{ endif ~}
        }

        # RTMP Application for serving HLS streams
        application hls {
            live on;                    # Enable live mode
            hls on;                     # Enable HLS support
            hls_path /var/www/hls;      # HLS files storage location
            hls_fragment 3;             # HLS segment duration in seconds
            hls_playlist_length 60;     # Playlist length

            # Declare variant playlists for adaptive bitrate streaming
            # These define the bandwidth and resolution for each quality level
            hls_variant _1080 BANDWIDTH=5000000,RESOLUTION=1920x1080;
            hls_variant _720  BANDWIDTH=2800000,RESOLUTION=1280x720;
            hls_variant _480  BANDWIDTH=1400000,RESOLUTION=854x480;
            hls_variant _360  BANDWIDTH=800000, RESOLUTION=640x360;
        }
    }
}


# ==== HTTP Configuration ====
http {
    sendfile on;                 # Enable efficient file transfers
    tcp_nopush on;               # Slightly improve TCP performance
    tcp_nodelay on;
    keepalive_timeout 65;        # Timeout for keep-alive client connections
    types_hash_max_size 2048;    # Internal optimization for MIME types

    include /etc/nginx/mime.types;   # Load MIME types (content-types mapping)
    default_type application/octet-stream;  # Default MIME type

    # Logging configuration
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Enable gzip compression for common text-based file types
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # HTTP server block to serve HLS content and stats
    server {
        listen 8080;              # HTTP port for HLS playback and stats
        server_name _;            # Catch-all server

        # CORS headers for cross-origin requests from players on other domains
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Range' always;

        # Serve HLS files under /live URL path
        location /live {
            alias /var/www/hls;    # Maps URI /live to physical directory /var/www/hls
            types {
                application/vnd.apple.mpegurl m3u8;  # HLS playlist MIME
                video/mp2t ts;                        # HLS segment MIME
            }
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin * always;
        }

        # RTMP stats interface - view streaming server status
        location /stats {
            rtmp_stat all;                 # Provide full RTMP status info in XML
            rtmp_stat_stylesheet stat.xsl; # Basic styling for human-readable stats
        }

        # Health check endpoint for monitoring
        location /health {
            access_log off;               # Disable logging of health checks
            return 200 "healthy\n";      # Return HTTP 200 with simple text response
            add_header Content-Type text/plain;
        }
    }
}
